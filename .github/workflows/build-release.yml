name: build-release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: 1.25.0
      - run: go install fyne.io/fyne/v2/cmd/fyne@latest
      - run: go mod tidy
      - run: go tool ryegen
      - run: go build -o rye-fyne.exe -ldflags="-s -w"
      - uses: actions/upload-artifact@v4
        with:
          name: rye-fyne-windows
          path: rye-fyne.exe

  build-linux:
    runs-on: ubuntu-latest
    container:
      image: alpine:edge
    steps:
      - name: Install build dependencies
        run: |
          apk add --no-cache \
            go gcc \
            libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev \
            linux-headers mesa-dev libxkbcommon-dev wayland-dev \
            git wget curl file

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version and IDs
        id: meta
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          DATE=$(date +%Y%m%d)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "appbundle_id=rye-fyne#xplshn:${VERSION}@${DATE}" >> $GITHUB_OUTPUT
          echo "output_name=rye-fyne-${VERSION}-amd64.dwfs.AppBundle" >> $GITHUB_OUTPUT

      - name: Build rye-fyne
        run: |
          go install fyne.io/fyne/v2/cmd/fyne@latest
          go mod tidy
          go tool ryegen
          go build -buildvcs=false -trimpath -ldflags="-s -w" -o rye-fyne

      - name: Prepare assets (icon + .desktop)
        run: |
          # Assumes rye.png and rye.desktop are in repo root
          cp rye.png rye.desktop .

      - name: Create classic portable tar.gz
        run: |
          strip --strip-unneeded rye-fyne
          tar czf rye-fyne-linux-amd64.tar.gz rye-fyne

      - name: Build .dwfs.AppBundle
        run: |
          # Fetch quick-sharun
          wget -qO /tmp/quick-sharun https://raw.githubusercontent.com/pkgforge-dev/Anylinux-AppImages/refs/heads/main/useful-tools/quick-sharun.sh
          chmod +x /tmp/quick-sharun

          # Prepare binary for sharun
          cp ./rye-fyne ./rye

          # Generate AppDir (ensures AppRun executable)
          ICON="./rye.png" DESKTOP="./rye.desktop" /tmp/quick-sharun ./rye

          # Fetch latest pelf for this arch
          wget -qO ./pelf "https://github.com/xplshn/pelf/releases/latest/download/pelf_$(uname -m)"
          chmod +x ./pelf

          # Package the AppDir into .dwfs.AppBundle
          ./pelf --add-appdir "./AppDir" \
                 --output-to "${{ steps.meta.outputs.output_name }}" \
                 --appbundle-id "${{ steps.meta.outputs.appbundle_id }}" \
                 --filesystem dwarfs \
                 --run-behavior 3

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rye-fyne-linux
          path: |
            rye-fyne-linux-amd64.tar.gz
            rye-fyne-*.dwfs.AppBundle

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: 1.25.0
      - run: go install fyne.io/fyne/v2/cmd/fyne@latest
      - run: go mod tidy
      - run: go tool ryegen
      - run: go build -o rye-fyne -ldflags="-s -w"
      - run: tar czf rye-fyne-macos-amd64.tar.gz rye-fyne
      - uses: actions/upload-artifact@v4
        with:
          name: rye-fyne-macos
          path: rye-fyne-macos-amd64.tar.gz

  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: rye-fyne-linux
      - uses: actions/download-artifact@v4
        with:
          name: rye-fyne-windows
      - uses: actions/download-artifact@v4
        with:
          name: rye-fyne-macos

      - name: Prepare release assets
        run: |
          # tar.gz
          mv rye-fyne-linux-amd64.tar.gz .
          # .dwfs.AppBundle
          mv rye-fyne-*.dwfs.AppBundle .
          # Windows
          mv rye-fyne-windows/rye-fyne.exe .
          # macOS
          tar xf rye-fyne-macos-amd64.tar.gz
          mv rye-fyne rye-fyne-macos-amd64

      - uses: softprops/action-gh-release@v2
        with:
          files: |
            rye-fyne.exe
            rye-fyne-linux-amd64.tar.gz
            rye-fyne-*.dwfs.AppBundle
            rye-fyne-macos-amd64
          name: Release ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
